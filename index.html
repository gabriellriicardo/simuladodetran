<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulado DETRAN-PE</title>

    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="manifest" href="favicon/site.webmanifest">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9eff5 100%);
        }
        .main-container {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        #question-content {
            transition: opacity 0.2s ease-in-out;
        }
        .option-label {
            transition: all 0.25s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .option-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        .option-label.selected {
            background-color: #e0f2fe;
            border-color: #38bdf8;
            color: #0c4a6e;
            box-shadow: 0 4px 15px rgba(56, 189, 248, 0.2);
        }
        .option-label.correct {
            background-color: #dcfce7 !important;
            border-color: #4ade80 !important;
            box-shadow: 0 4px 15px rgba(74, 222, 128, 0.2);
        }
        .option-label.incorrect {
            background-color: #fee2e2 !important;
            border-color: #f87171 !important;
            box-shadow: 0 4px 15px rgba(248, 113, 113, 0.2);
        }
        .nav-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .nav-btn.not-answered { background-color: #fff; color: #ef4444; border-color: #fecaca; }
        .nav-btn.current { background-color: #fef08a; color: #a16207; border-color: #facc15; transform: scale(1.1); box-shadow: 0 4px 10px rgba(250, 204, 21, 0.4);}
        .nav-btn.answered { background-color: #dcfce7; color: #166534; border-color: #86efac;}
        .nav-btn:hover { transform: scale(1.1); }
        .check-icon {
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.25s ease;
        }
        .option-label.selected .check-icon {
            opacity: 1;
            transform: scale(1);
        }
        .btn-primary {
            background: linear-gradient(to right, #3b82f6, #2563eb);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px -5px rgba(59, 130, 246, 0.6);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px -5px rgba(59, 130, 246, 0.8);
        }
        .btn-secondary {
            background-color: #475569;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px -5px rgba(71, 85, 105, 0.5);
        }
        .btn-secondary:hover {
            background-color: #334155;
            transform: translateY(-2px);
            box-shadow: 0 7px 20px -5px rgba(71, 85, 105, 0.7);
        }
        .btn-success {
            background: linear-gradient(to right, #22c55e, #16a34a);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px -5px rgba(34, 197, 94, 0.6);
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px -5px rgba(34, 197, 94, 0.8);
        }
        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: conic-gradient(
                #22c55e var(--p), 
                #e5e7eb 0
            );
        }
        .test-type-card {
            transition: all 0.2s ease-in-out;
            border-width: 2px;
        }
        input[type="radio"]:checked + .test-type-card {
            border-color: #3b82f6;
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.2);
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="app" class="main-container max-w-5xl mx-auto p-4 md:p-8">
        
        <!-- Start Screen -->
        <div id="start-screen" class="bg-white/70 backdrop-blur-sm border border-slate-200 p-8 rounded-2xl shadow-xl overflow-hidden">
            <div class="text-center">
                <h1 class="text-4xl lg:text-5xl font-extrabold text-slate-900 mb-3 leading-tight">Simulado Teórico DETRAN-PE</h1>
                <p class="text-slate-600 text-lg mb-8 max-w-2xl mx-auto">Prepare-se para a prova oficial com questões atualizadas e garanta sua aprovação.</p>
                
                <div class="w-full max-w-md mx-auto mb-8">
                    <label for="name-input" class="block text-slate-700 font-semibold mb-2">Primeiro, qual é o seu nome?</label>
                    <input type="text" id="name-input" placeholder="Digite seu nome (opcional)" class="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-sm">
                </div>

                <div class="max-w-3xl mx-auto mb-8">
                    <h2 class="text-xl font-bold mb-4 text-slate-800">Escolha o tipo de prova:</h2>
                    <div id="test-type-selection" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Test type options will be injected here -->
                    </div>
                </div>
                
                <button id="start-btn" class="btn-primary text-white font-bold py-4 px-10 rounded-full text-lg inline-flex items-center gap-3 group">
                    Iniciar Simulado
                    <svg class="w-6 h-6 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                </button>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="hidden">
            <div class="flex flex-col lg:flex-row justify-between items-start gap-8 mb-6">
                <div class="w-full lg:w-auto lg:max-w-md">
                    <div id="question-nav-grid" class="grid grid-cols-5 sm:grid-cols-10 lg:grid-cols-5 gap-2">
                        <!-- Navigation buttons will be injected here -->
                    </div>
                </div>
                <div class="w-full lg:flex-grow flex flex-col gap-4">
                     <div class="flex justify-start items-center gap-x-4 gap-y-2 text-sm flex-wrap p-3 bg-white/70 rounded-lg border">
                        <div class="flex items-center gap-2"><div class="w-4 h-4 rounded-md border-2" style="background-color: #fff; border-color: #fecaca;"></div><span>Pendente</span></div>
                        <div class="flex items-center gap-2"><div class="w-4 h-4 rounded-md border-2" style="background-color: #fef08a; border-color: #facc15;"></div><span>Atual</span></div>
                        <div class="flex items-center gap-2"><div class="w-4 h-4 rounded-md border-2" style="background-color: #dcfce7; border-color: #86efac;"></div><span>Respondida</span></div>
                    </div>
                    <div id="timer" class="w-full text-4xl font-bold text-blue-800 bg-blue-100/80 p-4 rounded-lg text-center border-2 border-blue-200">40:00</div>
                </div>
            </div>

            <div class="bg-white/70 backdrop-blur-sm border border-slate-200 rounded-2xl shadow-xl p-6 sm:p-8 flex flex-col justify-between min-h-[480px]">
                <div id="question-content">
                    <p id="question-title" class="text-xl font-bold text-slate-900 mb-6"></p>
                    <div id="question-image-container" class="mb-6 flex justify-center"></div>
                    <div id="question-options" class="space-y-3"></div>
                </div>
                <div class="flex justify-end gap-4 mt-6 pt-6 border-t border-slate-200">
                     <button id="prev-btn" class="py-2 px-5 bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-sm">&larr; Anterior</button>
                     <button id="next-btn" class="py-2 px-5 bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-sm">Próxima &rarr;</button>
                </div>
            </div>
            
            <div class="mt-8 flex justify-center">
                <button id="submit-btn" class="btn-success w-full max-w-sm text-white font-bold py-4 px-6 rounded-full text-lg">
                    Entregar Prova
                </button>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="hidden text-center bg-white/70 backdrop-blur-sm border border-slate-200 p-8 rounded-2xl shadow-xl">
            <div id="result-icon" class="mx-auto mb-4"></div>
            <h1 id="result-title" class="text-4xl font-extrabold mb-2"></h1>
            <p id="result-message" class="text-slate-600 text-lg mb-6"></p>
            <div id="score-wrapper" class="relative my-8 flex justify-center">
                 <div id="score-circle" style="--p:0%;">
                    <div class="bg-white w-[120px] h-[120px] rounded-full flex items-center justify-center text-4xl font-bold" id="score"></div>
                 </div>
            </div>
             <div class="bg-white/80 p-6 rounded-lg border border-slate-200 text-left max-w-md mx-auto mb-8">
                <h3 class="text-xl font-bold mb-3 text-slate-800">Seu Desempenho</h3>
                <div class="space-y-3 text-slate-700">
                    <p class="flex justify-between">Total de Questões: <span id="total-questions-summary" class="font-bold"></span></p>
                    <p class="flex justify-between">Respostas Corretas: <span id="correct-answers" class="font-bold text-green-600"></span></p>
                    <p class="flex justify-between">Respostas Incorretas: <span id="incorrect-answers" class="font-bold text-red-600"></span></p>
                </div>
             </div>

             <div id="reprovado-dicas" class="hidden text-left max-w-lg mx-auto mt-8 bg-amber-50 border-2 border-amber-200 p-6 rounded-xl">
                <h3 class="text-xl font-bold mb-4 text-amber-800">Dicas para a Próxima Tentativa</h3>
                <ul class="space-y-4 text-slate-700">
                    <li class="flex items-start gap-3">
                        <svg class="w-6 h-6 text-amber-600 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        <div><span class="font-semibold">Revise suas respostas:</span> Clique no botão "Revisar Respostas" para entender onde errou e focar nos pontos fracos.</div>
                    </li>
                    <li class="flex items-start gap-3">
                        <svg class="w-6 h-6 text-amber-600 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                        <div><span class="font-semibold">Foque nos temas:</span> Identifique os assuntos que mais errou (Placas, Primeiros Socorros, etc.) e reforce os estudos.</div>
                    </li>
                    <li class="flex items-start gap-3">
                         <svg class="w-6 h-6 text-amber-600 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v1.5M12 17.75V19M9.034 7.966l-1.06 1.06M16.026 14.974l-1.06 1.06M6.253 12H4.75M19.25 12h-1.5M9.034 16.026l-1.06-1.06M16.026 9.034l-1.06-1.06"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14.75a2.75 2.75 0 100-5.5 2.75 2.75 0 000 5.5z"></path></svg>
                        <div><span class="font-semibold">Consulte o Manual Oficial:</span> O manual do DETRAN é sua principal fonte de estudo. Garanta que o está utilizando.</div>
                    </li>
                </ul>
            </div>

             <div class="flex flex-col sm:flex-row gap-4 justify-center mt-8">
                <button id="review-btn" class="btn-secondary w-full sm:w-auto text-white font-bold py-3 px-8 rounded-full">
                    Revisar Respostas
                </button>
                <button id="restart-btn" class="btn-primary w-full sm:w-auto text-white font-bold py-3 px-8 rounded-full">
                    Refazer Simulado
                </button>
            </div>
        </div>
    </div>
    
    <footer class="text-center py-4">
        <p class="text-xs text-slate-500">Desenvolvido por Gabriel Ricardo</p>
    </footer>

    <script>
        // --- DOM Elements ---
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultScreen = document.getElementById('result-screen');
        const startBtn = document.getElementById('start-btn');
        const nameInput = document.getElementById('name-input');
        const submitBtn = document.getElementById('submit-btn');
        const restartBtn = document.getElementById('restart-btn');
        const reviewBtn = document.getElementById('review-btn');
        const questionContent = document.getElementById('question-content');
        const questionTitleEl = document.getElementById('question-title');
        const questionImageContainer = document.getElementById('question-image-container');
        const questionOptionsEl = document.getElementById('question-options');
        const timerEl = document.getElementById('timer');
        const questionNavGrid = document.getElementById('question-nav-grid');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const scoreCircle = document.getElementById('score-circle');
        const resultIcon = document.getElementById('result-icon');
        const reprovadoDicas = document.getElementById('reprovado-dicas');
        const testTypeSelection = document.getElementById('test-type-selection');
        const totalQuestionsSummary = document.getElementById('total-questions-summary');

        // --- Icons ---
        const checkSVG = `<svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
        const correctSVG = `<svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
        const incorrectSVG = `<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
        const trophySVG = `<svg class="w-20 h-20 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12.7.69a.75.75 0 00-1.4 0L8.62 5.2a.75.75 0 01-.57.41H3.5a.75.75 0 00-.73.93l1.25 4.38a.75.75 0 01-.1.65L.5 15.43a.75.75 0 00.62 1.27l4.38-1.25a.75.75 0 01.65.1l4.5 2.68a.75.75 0 00.7 0l4.5-2.68a.75.75 0 01.65-.1l4.38 1.25a.75.75 0 00.62-1.27l-3.42-3.86a.75.75 0 01-.1-.65l1.25-4.38a.75.75 0 00-.73-.93h-4.55a.75.75 0 01-.57-.41L12.7.69zM12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"/><path d="M18 19.5H6a.75.75 0 000 1.5h12a.75.75 0 000-1.5zM6.75 22.5h10.5a.75.75 0 000-1.5H6.75a.75.75 0 000 1.5z"/></svg>`;
        const sadFaceSVG = `<svg class="w-20 h-20 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-3.5-9c.828 0 1.5.672 1.5 1.5s-.672 1.5-1.5 1.5S7 12.328 7 11.5 7.672 10 8.5 10zm7 0c.828 0 1.5.672 1.5 1.5s-.672 1.5-1.5 1.5-1.5-.672-1.5-1.5.672-1.5 1.5-1.5zm-5.03 4.5c.29.29.68.44 1.06.44s.77-.15 1.06-.44l.94-.94c.29-.29.29-.77 0-1.06s-.77-.29-1.06 0l-.94.94c-.29.29-.29.77 0 1.06z"/></svg>`;
        
        // --- Test Configurations ---
        const testTypes = {
            'primeira-habilitacao': {
                title: 'Primeira Habilitação',
                description: '30 questões sobre todos os temas. (40 min)',
                totalQuestions: 30,
                time: 40 * 60,
                passingScore: 21,
                categories: ['defensive', 'first-aid', 'mechanics', 'environment', 'legislation', 'signs']
            },
            'renovacao': {
                title: 'Renovação CNH',
                description: '15 questões de Primeiros Socorros e Direção Defensiva. (25 min)',
                totalQuestions: 15,
                time: 25 * 60,
                passingScore: 11,
                categories: ['defensive', 'first-aid']
            },
            'reciclagem': {
                title: 'Reciclagem',
                description: '30 questões para revalidar seus conhecimentos. (40 min)',
                totalQuestions: 30,
                time: 40 * 60,
                passingScore: 21,
                categories: ['defensive', 'first-aid', 'mechanics', 'environment', 'legislation', 'signs']
            }
        };
        let selectedTestConfig = {};

        // --- State ---
        let allQuestions = [];
        let currentQuestions = [];
        let userAnswers = [];
        let currentQuestionIndex = 0;
        let timerInterval;
        let quizFinished = false;
        let reviewMode = false;
        let userName = '';

        // --- Functions ---
        async function fetchQuestions(filename) {
            try {
                const response = await fetch(filename);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Could not fetch ${filename}:`, error);
                alert(`Erro ao carregar as questões do arquivo ${filename}. Verifique se o arquivo existe e está no servidor web. Detalhes no console.`);
                return []; 
            }
        }

        async function loadAllQuestions() {
            const filenames = [
                "direcao_defensiva.json",
                "primeiros_socorros.json",
                "meio_ambiente_e_cidadania.json",
                "mecanica.json",
                "legislacao.json",
                "placas.json"
            ];

            const promises = filenames.map(filename => fetchQuestions(filename));
            const results = await Promise.all(promises);
            allQuestions = [].concat(...results);
        }

        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function buildTestTypeOptions() {
            testTypeSelection.innerHTML = '';
            Object.keys(testTypes).forEach((key, index) => {
                const config = testTypes[key];
                const isChecked = index === 0 ? 'checked' : '';
                const optionHTML = `
                    <div>
                        <input type="radio" name="test-type" id="${key}" value="${key}" class="hidden" ${isChecked}>
                        <label for="${key}" class="test-type-card cursor-pointer block bg-white p-4 rounded-lg border-gray-200 shadow-sm text-center">
                            <h3 class="font-bold text-lg text-slate-800">${config.title}</h3>
                            <p class="text-sm text-slate-500">${config.description}</p>
                        </label>
                    </div>
                `;
                testTypeSelection.innerHTML += optionHTML;
            });
        }

        function setupQuiz() {
            const selectedType = document.querySelector('input[name="test-type"]:checked').value;
            selectedTestConfig = testTypes[selectedType];

            const filteredQuestions = allQuestions.filter(q => selectedTestConfig.categories.includes(q.category));
            currentQuestions = shuffle(filteredQuestions).slice(0, selectedTestConfig.totalQuestions);
            
            userAnswers = new Array(currentQuestions.length).fill(null);
            currentQuestionIndex = 0;
            quizFinished = false;
            reviewMode = false;
            
            buildNavGrid();
            displayQuestion(0);
            
            submitBtn.disabled = false;
            submitBtn.classList.remove('hidden');
        }

        function buildNavGrid() {
            questionNavGrid.innerHTML = '';
            for (let i = 0; i < currentQuestions.length; i++) {
                const navBtn = document.createElement('button');
                navBtn.className = 'nav-btn';
                navBtn.textContent = String(i + 1).padStart(2, '0');
                navBtn.dataset.index = i;
                navBtn.addEventListener('click', () => {
                    displayQuestion(i);
                });
                questionNavGrid.appendChild(navBtn);
            }
        }

        function addOptionListenersForCurrentQuestion() {
            questionOptionsEl.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (reviewMode) return;
                    userAnswers[currentQuestionIndex] = parseInt(e.target.value);
                    
                    const labels = questionOptionsEl.querySelectorAll('.option-label');
                    labels.forEach(label => {
                        label.classList.remove('selected');
                        label.querySelector('.check-icon').innerHTML = '';
                    });
                    const selectedLabel = document.querySelector(`label[for="${e.target.id}"]`);
                    selectedLabel.classList.add('selected');
                    selectedLabel.querySelector('.check-icon').innerHTML = checkSVG;
                    
                    updateNavGrid();
                });
            });
        }

        function displayQuestion(index) {
            if (index < 0 || index >= currentQuestions.length) return;
            currentQuestionIndex = index;

            const questionData = currentQuestions[index];

            questionContent.style.opacity = 0;

            setTimeout(() => {
                questionTitleEl.textContent = `${index + 1}. ${questionData.question}`;
                
                questionImageContainer.innerHTML = '';
                if (questionData.image) {
                    const img = document.createElement('img');
                    img.src = questionData.image;
                    img.alt = `Placa de trânsito para a questão ${index + 1}`;
                    img.className = 'mx-auto h-40 w-40 object-contain';
                    img.onerror = () => { img.style.display = 'none'; }; // Hide if image fails to load
                    questionImageContainer.appendChild(img);
                }

                let optionsHTML = '';
                questionData.options.forEach((option, i) => {
                    if (reviewMode) {
                        const isCorrectAnswer = i === questionData.answer;
                        const isUserAnswer = userAnswers[index] === i;
                        let labelClass = 'border-slate-200';
                        let iconHTML = '';

                        if (isCorrectAnswer) {
                            labelClass = 'correct';
                            if (isUserAnswer) iconHTML = correctSVG;
                        } else if (isUserAnswer) {
                            labelClass = 'incorrect';
                            iconHTML = incorrectSVG;
                        }
                        optionsHTML += `<div><label class="option-label block w-full p-4 border-2 rounded-lg cursor-default ${labelClass}"><div><span class="font-bold mr-3">${String.fromCharCode(65 + i)})</span> ${option}</div><div class="check-icon" style="opacity: 1; transform: scale(1);">${iconHTML}</div></label></div>`;
                    } else {
                        const isChecked = userAnswers[index] === i ? 'checked' : '';
                        const isSelectedClass = userAnswers[index] === i ? 'selected' : '';
                        optionsHTML += `<div><input type="radio" name="question${index}" id="q${index}o${i}" value="${i}" class="hidden" ${isChecked}><label for="q${index}o${i}" class="option-label block w-full p-4 border-2 border-slate-200 rounded-lg cursor-pointer ${isSelectedClass}"><div><span class="font-bold mr-3">${String.fromCharCode(65 + i)})</span> ${option}</div><div class="check-icon">${isSelectedClass ? checkSVG : ''}</div></label></div>`;
                    }
                });
                questionOptionsEl.innerHTML = optionsHTML;

                if (!reviewMode) {
                    addOptionListenersForCurrentQuestion();
                }
                
                updateNavGrid();
                updateNavButtons();

                questionContent.style.opacity = 1;
            }, 200);
        }
        
        function updateNavGrid() {
            const navBtns = questionNavGrid.querySelectorAll('.nav-btn');
            navBtns.forEach((btn, index) => {
                btn.classList.remove('not-answered', 'current', 'answered');
                if (index === currentQuestionIndex) {
                    btn.classList.add('current');
                } else if (userAnswers[index] !== null) {
                    btn.classList.add('answered');
                } else {
                    btn.classList.add('not-answered');
                }
            });
        }

        function updateNavButtons() {
            prevBtn.disabled = currentQuestionIndex === 0;
            nextBtn.disabled = currentQuestionIndex === currentQuestions.length - 1;
        }

        function startTimer(duration) {
            let timer = duration;
            timerInterval = setInterval(() => {
                const minutes = String(Math.floor(timer / 60)).padStart(2, '0');
                const seconds = String(timer % 60).padStart(2, '0');
                timerEl.textContent = `${minutes}:${seconds}`;
                if (--timer < 0) {
                    clearInterval(timerInterval);
                    finishQuiz();
                }
            }, 1000);
        }

        function finishQuiz() {
            if (quizFinished) return;
            quizFinished = true;
            clearInterval(timerInterval);

            let correctCount = 0;
            currentQuestions.forEach((q, index) => {
                if (userAnswers[index] === q.answer) {
                    correctCount++;
                }
            });

            const percentage = Math.round((correctCount / currentQuestions.length) * 100);
            const passed = correctCount >= selectedTestConfig.passingScore;

            document.getElementById('score').textContent = `${percentage}%`;
            scoreCircle.style.setProperty('--p', `${percentage}%`);
            if (passed) {
                scoreCircle.style.setProperty('background', `conic-gradient(#22c55e ${percentage}%, #e5e7eb 0)`);
            } else {
                scoreCircle.style.setProperty('background', `conic-gradient(#ef4444 ${percentage}%, #e5e7eb 0)`);
            }

            totalQuestionsSummary.textContent = selectedTestConfig.totalQuestions;
            document.getElementById('correct-answers').textContent = correctCount;
            document.getElementById('incorrect-answers').textContent = currentQuestions.length - correctCount;

            const resultTitle = document.getElementById('result-title');
            const resultMessage = document.getElementById('result-message');
            
            if (passed) {
                resultIcon.innerHTML = trophySVG;
                resultTitle.textContent = `Parabéns, ${userName}!`;
                resultTitle.className = "text-4xl font-extrabold mb-2 text-green-600";
                resultMessage.textContent = "Excelente desempenho! Você está pronto para a prova oficial.";
                reprovadoDicas.classList.add('hidden');
            } else {
                resultIcon.innerHTML = sadFaceSVG;
                resultTitle.textContent = `Continue estudando, ${userName}!`;
                resultTitle.className = "text-4xl font-extrabold mb-2 text-red-600";
                
                const motivationalPhrases = [
                    "A persistência é o caminho do êxito.",
                    "Cada erro é um passo para mais perto do acerto.",
                    "A jornada é feita de altos e baixos. Continue focado!",
                    "O sucesso é a soma de pequenos esforços repetidos."
                ];
                const randomPhrase = motivationalPhrases[Math.floor(Math.random() * motivationalPhrases.length)];
                resultMessage.textContent = `Não desanime. ${randomPhrase}`;
                reprovadoDicas.classList.remove('hidden');
            }
            
            quizScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
        }
        
        function showReview() {
            reviewMode = true;
            quizScreen.classList.remove('hidden');
            resultScreen.classList.add('hidden');
            submitBtn.classList.add('hidden');
            displayQuestion(0);
        }

        // --- Event Listeners ---
        startBtn.addEventListener('click', () => {
            userName = nameInput.value.trim();
            if (userName === '') {
                userName = 'Candidato(a)';
            }

            startScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            setupQuiz();
            startTimer(selectedTestConfig.time);
        });

        submitBtn.addEventListener('click', () => {
            const unanswered = userAnswers.filter(a => a === null).length;
            if (unanswered > 0) {
                if (confirm(`Você ainda tem ${unanswered} questões não respondidas. Deseja entregar a prova mesmo assim?`)) {
                    finishQuiz();
                }
            } else {
                if (confirm('Tem certeza que deseja entregar a prova?')) {
                    finishQuiz();
                }
            }
        });

        restartBtn.addEventListener('click', () => {
            resultScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
        });
        
        reviewBtn.addEventListener('click', () => {
            showReview();
        });

        prevBtn.addEventListener('click', () => displayQuestion(currentQuestionIndex - 1));
        nextBtn.addEventListener('click', () => displayQuestion(currentQuestionIndex + 1));

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAllQuestions();
            buildTestTypeOptions();
        });

    </script>
</body>
</html>
